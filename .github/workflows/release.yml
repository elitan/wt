name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-latest
            target: darwin-arm64
          - os: macos-15-intel
            target: darwin-x64
          - os: ubuntu-latest
            target: linux-x64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - run: bun install

      - name: Build binary
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          bun build --compile --minify \
            --define "process.env.VERSION=\"$VERSION\"" \
            --outfile wt-${{ matrix.target }} \
            src/index.ts

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wt-${{ matrix.target }}
          path: wt-${{ matrix.target }}

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: binaries
          merge-multiple: true

      - name: Create release
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const tag = context.ref.replace('refs/tags/', '');

            const { data: tags } = await github.rest.repos.listTags({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 10
            });

            const previousTag = tags.find(t => t.name !== tag)?.name;

            let commits = [];
            if (previousTag) {
              const { data: comparison } = await github.rest.repos.compareCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                base: previousTag,
                head: tag
              });
              commits = comparison.commits;
            }

            const features = [];
            const fixes = [];
            const other = [];

            for (const commit of commits) {
              const msg = commit.commit.message.split('\n')[0];
              const sha = commit.sha.substring(0, 7);
              const author = commit.author?.login || commit.commit.author.name;
              if (msg.startsWith('chore: release')) continue;

              const entry = `- ${msg} (${sha}) @${author}`;

              if (msg.startsWith('feat:') || msg.startsWith('feat(')) {
                features.push(entry);
              } else if (msg.startsWith('fix:') || msg.startsWith('fix(')) {
                fixes.push(entry);
              } else {
                other.push(entry);
              }
            }

            let body = '';
            if (features.length) body += '## Features\n\n' + features.join('\n') + '\n\n';
            if (fixes.length) body += '## Bug Fixes\n\n' + fixes.join('\n') + '\n\n';
            if (other.length) body += '## Other Changes\n\n' + other.join('\n') + '\n\n';
            if (previousTag) {
              body += `**Full Changelog**: https://github.com/${context.repo.owner}/${context.repo.repo}/compare/${previousTag}...${tag}`;
            }

            const files = fs.readdirSync('binaries');
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: tag,
              body: body || 'No changes recorded.'
            });

            for (const file of files) {
              const content = fs.readFileSync(`binaries/${file}`);
              await github.rest.repos.uploadReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: (await github.rest.repos.getReleaseByTag({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag: tag
                })).data.id,
                name: file,
                data: content
              });
            }
