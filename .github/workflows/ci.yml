name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - run: bun install
      - run: bun run lint

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - run: bun install
      - run: bun run typecheck

  e2e:
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - run: bun install

      - name: Build binary
        run: bun run build

      - name: Setup test repo with origin
        run: |
          git config --global user.email "test@test.com"
          git config --global user.name "Test"
          git config --global init.defaultBranch main
          mkdir -p /tmp/origin.git
          cd /tmp/origin.git
          git init --bare
          mkdir -p /tmp/test-repo
          cd /tmp/test-repo
          git init
          echo "test" > README.md
          echo '{"name":"test"}' > package.json
          echo ".env" > .gitignore
          echo "SECRET=abc123" > .env
          touch bun.lockb
          git add .
          git commit -m "init"
          git remote add origin /tmp/origin.git
          git push -u origin main

      - name: Test --help
        run: ./wt-dev --help

      - name: Test --version
        run: ./wt-dev --version | grep -E '^dev$'

      - name: Test list
        run: cd /tmp/test-repo && $GITHUB_WORKSPACE/wt-dev list

      - name: Test new worktree
        run: cd /tmp/test-repo && $GITHUB_WORKSPACE/wt-dev new test-branch 2>&1 | grep -v "^cd "

      - name: Verify worktree created
        run: cd /tmp/test-repo && $GITHUB_WORKSPACE/wt-dev list 2>&1 | grep test-branch

      - name: Verify .env copied to worktree
        run: |
          WT_PATH=$(ls -d ~/.wt/test-repo/*test-branch)
          test -f "$WT_PATH/.env" && grep "SECRET=abc123" "$WT_PATH/.env"

      - name: Test rm with -y
        run: cd /tmp/test-repo && $GITHUB_WORKSPACE/wt-dev rm test-branch -y 2>&1 | grep "Removed"
